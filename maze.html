<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html" charset="utf-8"/>
    <title>M A Z E</title>
    <style>
    html, body { overflow:   hidden;    width: 100%;    height: 100%;     margin: 0;    padding: 0;    }
    #viewer    { touch-action: none;    width: 100%;    height: 100%;                            }
    </style>
</head>
<body>

    <canvas id='viewer' />
    <script src ='lib/babylon.max.js'> </script>
    <script src ='lib/babylonjs.loaders.min.js'> </script>
    <script type='module'>

    import { rad,grad,setDeadZone,loadGlb,Ramp,Ramp3  } from './functions.js';
    import { HeadUpDisplay  } from './hud.js';
    import { Space          } from './space2.js';
    import { User           } from './user.js';
    import { Control        } from './control.js';

    /**/
    // To see errors on touch devices, activate this Errorhandler producing Galert dialogs
    window.onerror = function(msg,url,line){
        alert(msg+'\n'+url+'\nLine: '+line)
        return true
    }
    /**/



    /*
        https://www.babylonjs-playground.com/#PYTAP9#2
    */



    ///////////// MAIN /////////////////////////////////

    var seconds  = 0;
    var vrHelper = undefined;
    var dSecX    = 1/60;
    var ground   = undefined;
    var user     = undefined; // local?
    var control  = undefined;



    window.addEventListener('DOMContentLoaded', function() {

        //// INIT
        var canvas = document.getElementById('viewer');
        var engine = new BABYLON.Engine(canvas, true);
        var scene  = new BABYLON.Scene (engine);
        var light  = new BABYLON.HemisphericLight('hemisLight', new BABYLON.Vector3(1,1,1), scene);

        scene.clearColor = BABYLON.Color3.Black();



        var fNEAR = 2;                          // to show the bike close by
        var fFAR  = 10*1000                     // to show the far away earth. Default: 10'000

        vrHelper = scene.createDefaultVRExperience(/*{defaultheight:0.801 NOP! }*/);
        vrHelper.deviceOrientationCamera.minZ   /= fNEAR    // 2d
        vrHelper.deviceOrientationCamera.maxZ   *= fFAR
        vrHelper.vrDeviceOrientationCamera.minZ /= fNEAR    // cardboard
        vrHelper.vrDeviceOrientationCamera.maxZ *= fFAR
        vrHelper.webVRCamera.minZ               /= fNEAR    // Oculus       currentVRCamera
        vrHelper.webVRCamera.maxZ               *= fFAR

        vrHelper.currentVRCamera.inputs.attached.keyboard.detachControl(); // Works, on-hooks are removed. But still attached :-/
        vrHelper.currentVRCamera.inputs.attached.mouse.detachControl(); //???


        scene.hud = new HeadUpDisplay(vrHelper.deviceOrientationCamera,scene);
        scene.hud.out(["TEST START"],3000);

        vrHelper.onEnteringVRObservable.add( ()=>{
            scene.hud.setParent(user.root, true);
        });
        vrHelper.onExitingVRObservable .add( ()=>{ scene.hud.setParent(vrHelper.deviceOrientationCamera); });

        vrHelper.onEnteringVR.add(()=>{
        });


        var space = new Space(scene);
        ground =
        space.ground(100,false,vrHelper);
        space.barks(9,5);
        space.skyDome(vrHelper);


        //        setCamera( new BABYLON.Vector3(0,1.6,0) );


        user    = new User(scene);
        //user.root.position = new BABYLON.Vector3(0,0,3.0)
        //    user.setSpeed(new BABYLON.Vector3(0,0,0.9));
        control = new Control(user, scene, engine, vrHelper);

        //// RENDER CYCLE
        engine.runRenderLoop(function() {
            var dSec1 = engine._deltaTime / 1000
            seconds += dSec1;

            // Why is dSec so irregular??? It causes optical odds while rotating
            var fact = 6
            dSecX = ( dSecX*(fact-1)+dSec1 ) / fact;

            if(user.root) {
                control.animate(dSecX,vrHelper);
                user   .animate(dSecX,vrHelper);
            }

            scene.render();
        });


    });// DOMContentLoaded


    </script>

</body>
</html>
