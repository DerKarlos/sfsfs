<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html" charset="utf-8"/>
    <title>M A Z E</title>
    <style>
    html, body { overflow:   hidden;    width: 100%;    height: 100%;     margin: 0;    padding: 0;    }
    #viewer    { touch-action: none;    width: 100%;    height: 100%;                            }
    </style>
</head>
<body>

    <canvas id='viewer' />
    <script src="https://cdn.babylonjs.com/babylon.max.js"></script>
<!--
<script src="https://cdn.babylonjs.com/babylonjs.loaders.min.js"></script>
<script src ='lib/babylon_4.0/babylonjs.loaders.min.js'> </script>
-->
    <script type='module'>

    import { rad,grad,setDeadZone,loadGlb,Ramp,Ramp3,getUrlParameter,limit  } from './src/functions.js';
    import { HeadUpDisplay  } from './src/hud.js';
    import { Space          } from './src/space.js';
    import { Maze           } from './src/maze2d.js';
    import { User           } from './src/user.js';
    import { Control        } from './src/control.js';

    /**/
    // To see errors on touch devices, activate this Errorhandler producing Ggalert dialogs
    window.onerror = function(msg,url,line){
        alert(msg+'\n'+url+'\nLine: '+line)
        return true
    }
    /**/

    ///////////// MAIN /////////////////////////////////

    var webvrOk = navigator.getVRDisplays!==undefined;
    var webxrOk = navigator.xr!==undefined;
    var web_rOk = webvrOk || webxrOk;
    var httpsOk = window.location.protocol=="https:";

    if(!httpsOk && window.location.host!="localhost") window.location = "https://"+ window.location.host + window.location.pathname;



    var seconds  = 0;
    var dSecX    = 1/60;
    var vrHelper = undefined;
    var ground   = undefined;
    var user     = undefined; // local?

    window.addEventListener('DOMContentLoaded', function() {

        //// INIT
        var canvas = document.getElementById('viewer');
        var engine = new BABYLON.Engine(canvas, true);
        var scene  = new BABYLON.Scene (engine);
        var light  = new BABYLON.HemisphericLight('hemisLight', new BABYLON.Vector3(1,1,1), scene);

        scene.clearColor = BABYLON.Color3.Black();
        scene.moveMode   = limit( getUrlParameter("m",1) * 1 ,1, 3);




        var fNEAR = 2;                          // to show the bike close by
        var fFAR  = 10*1000                     // to show the far away earth. Default: 10'000

        vrHelper = scene.createDefaultVRExperience(/*{defaultheight:0.801 NOP! }*/);
        vrHelper.deviceOrientationCamera.minZ   /= fNEAR    // 2d
        vrHelper.deviceOrientationCamera.maxZ   *= fFAR
        if(webvrOk) {
            vrHelper.vrDeviceOrientationCamera.minZ /= fNEAR    // cardboard
            vrHelper.vrDeviceOrientationCamera.maxZ *= fFAR
            vrHelper.webVRCamera.minZ               /= fNEAR    // Oculus       currentVRCamera
            vrHelper.webVRCamera.maxZ               *= fFAR
        }

        vrHelper.currentVRCamera.inputs.attached.keyboard.detachControl(); // Works, on-hooks are removed. But still attached :-/
        vrHelper.currentVRCamera.inputs.attached.mouse.detachControl(); //???


        scene.hud = new HeadUpDisplay(vrHelper.deviceOrientationCamera,scene);
        scene.hud.out(["TEST START", "move mode: "+scene.moveMode],3000);

        vrHelper.onEnteringVRObservable.add( ()=>{
            scene.hud.setParent(user.root, true);
        });
        vrHelper.onExitingVRObservable .add( ()=>{ scene.hud.setParent(vrHelper.deviceOrientationCamera); });

        vrHelper.onEnteringVR.add(()=>{
        });



        // Warum geht das nicht in der exported class ???
        vrHelper.onControllerMeshLoaded.add((webVRController)=>{
            webVRController.onAButtonStateChangedObservable.add((stateObject)=>{ //    X <=> A
                if(user.control) {

                    if(stateObject.pressed === true){
                        user.control.setPositionOffset(vrHelper);
                        user.control.keyXA = true;
                    } else {
                        user.control.keyXA = false;
                    }

                }
            });
        });


        var space = new Space(scene);
        ground =
        space.ground(100, scene.moveMode==1, vrHelper);
        space.barks(9,5);
        space.skyDome(vrHelper);
        /**
***/
        var maze = new Maze(3,scene);
        maze.maze.position.x = -20;


        user    = new User(scene);

        if(scene.moveMode>1)
        user.control = new Control(user, scene, engine, vrHelper);

        //// RENDER CYCLE
        engine.runRenderLoop(function() {
            var dSec1 = engine._deltaTime / 1000
            seconds += dSec1;

            // Why is dSec so irregular??? It causes optical odds while rotating
            var fact = 6
            dSecX = ( dSecX*(fact-1)+dSec1 ) / fact;

            if( user && scene.moveMode>1 ) {
                user.animate(dSecX,vrHelper);
            }

            scene.render();
        });


    });// DOMContentLoaded


    </script>

</body>
</html>
